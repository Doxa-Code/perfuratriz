// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "."
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model NCM {
  id     String @id @default(uuid())
  code   Float
  tax    Float
  icms   Float
  pis    Float
  cofins Float
  ipi    Float

  @@map("ncms")
}

model Product {
  id     String @id @default(uuid())
  name   String @default("")
  weight Float
  length Float
  height Float
  width  Float

  ncm   ProductNCM @relation(fields: [ncmId], references: [id], onDelete: Cascade)
  ncmId String     @unique

  @@map("products")
}

model ProductNCM {
  id     String @id @default(uuid())
  ncmId  String @default("")
  code   Float
  cofins Float
  icms   Float
  ipi    Float
  pis    Float
  tax    Float

  product Product?

  @@map("product_ncm")
}

model Invoice {
  id           String           @id @default(uuid())
  registration String
  createdAt    DateTime         @default(now())
  quote        Float
  products     InvoiceProduct[]
  declaration  Declaration?

  @@map("invoices")
}

model InvoiceProduct {
  id String @id @default(uuid())

  productId     String
  productName   String @default("")
  productWeight Float
  productLength Float
  productHeight Float
  productWidth  Float

  ncmCode   Float
  ncmCofins Float
  ncmIcms   Float
  ncmIpi    Float
  ncmPis    Float
  ncmTax    Float

  quantity Int   @default(1)
  amount   Float @default(0)

  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String

  @@map("invoice_products")
}

model Expense {
  id               String           @id @default(uuid())
  name             String
  useICMSBase      Boolean          @default(false)
  useCustomsBase   Boolean          @default(false)
  allocationMethod AllocationMethod
  currency         Currency

  @@map("expenses")
}

enum AllocationMethod {
  NET_WEIGHT
  NET_VALUE
  PER_UNIT
}

enum Currency {
  USD
  BRL
}

model Declaration {
  id           String               @id @default(uuid())
  registration String
  quote        Float
  invoiceId    String               @unique
  invoice      Invoice              @relation(fields: [invoiceId], references: [id])
  expenses     ExpenseDeclaration[]

  @@map("declarations")
}

model ExpenseDeclaration {
  id               String           @id @default(uuid())
  declaration      Declaration      @relation(fields: [declarationId], references: [id], onDelete: Cascade)
  declarationId    String
  name             String
  useICMSBase      Boolean          @default(false)
  useCustomsBase   Boolean          @default(false)
  allocationMethod AllocationMethod
  currency         Currency
  amount           Float            @default(0)

  @@map("expense_declarations")
}
